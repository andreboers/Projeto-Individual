<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/usuario.css">
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>MineTech | Comece agora</title>
</head>

<body>

    <div id="divContainerLogin" class="visible">

        <div class="botaoSairLogin">
            <a href="index.html" class="botaoSair">
                <i class="fa-solid fa-arrow-left"></i>
                <span id="textoBotaoSair">Início</span>
            </a>
        </div>

        <!-- Login de Usuário -->
        <div class="divBoxLogin">

            <h1>Faça Login</h1>

            <form>
                <!-- Login -->
                <div class="divCampo" id="div_campoEmailLogin">
                    <input type="text" id="i_emailLogin" required autocomplete="off">
                    <div class="textoInput-email">
                        <i class="fa fa-user" aria-hidden="true"></i>
                        <span>Email</span>
                    </div>
                </div>

                <!-- Senha -->
                <div class="divCampo" id="div_campoSenhaLogin">
                    <button type="button" id="i_buttonEyeSenhaLogin" onclick="exibirSenhaLogin()" tabindex="-1">
                        <div id="iconeEyesLogin">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_senhaLogin" required autocomplete="off">
                    <div class="textoInput-senha">
                        <i class="fas fa-lock"></i>
                        <span>Senha</span>
                    </div>

                </div>

            </form>

            <!-- Botão que executa um select no database -->
            <button id="botaoLogin" onclick="entrar()">Entrar</button>



            <div class="botaoCadastreSe">
                <a>Não possui uma conta?</a>

                <div id="iconeCadastreSe" onclick="irParaCadastro()"><span>Cadastre-se</span></div>
            </div>

        </div>

        <div class="divBannerLogin">
        </div>

    </div>


    <!-- Cadastro de Usuário -->
    <div id="divContainerCadastreSe" class="hidden">

        <div class="divBannerCadastro">
        </div>

        <div class="botaoSairCadastro">
            <a href="index.html" class="botaoSair">
                <i class="fa-solid fa-arrow-left"></i>
                <span id="textoBotaoSair">Inicio</span>
            </a>
        </div>

        <div class="divBoxCadastro">

            <h1>Faça seu Cadastro</h1>

            <form>
                <!-- Nome -->
                <div class="divCampo" id="div_campoNomeCadastro">
                    <input type="text" id="i_nomeCadastro" required autocomplete="off">
                    <div class="textoInput-nomeCad">
                        <i class="fa fa-user" aria-hidden="true"></i>
                        <span>Nome</span>
                    </div>
                </div>
                <!-- Email -->
                <div class="divCampo" id="div_campoEmailCadastro">
                    <input type="text" id="i_emailCadastro" required autocomplete="new-email">
                    <div class="textoInput-emailCad">
                        <i class="fa-solid fa-at"></i>
                        <span>Email</span>
                    </div>
                </div>

                <!-- Senha -->
                <div class="divCampo" id="div_campoSenhaCadastro">
                    <button type="button" id="i_buttonEyeSenhaCadastro" onclick="exibirSenhaCadastro()" tabindex="-1">
                        <div id="iconeEyesSenhaCadastro">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_senhaCadastro" oninput="validarSenha()" required autocomplete="off">
                    <div class="textoInput-senhaCad">
                        <i class="fas fa-lock"></i>
                        <span>Senha</span>
                    </div>
                </div>

                <div id="div_validarSenha">
                    <span class="span_NecSenha">A senha deve conter 8 caracteres, incluindo 1 letra maiúscula, 1
                        letra
                        minúscula e 1 caractere especial.</span>
                </div>

                <!-- Confirmação de Senha -->
                <div class="divCampo" id="div_campoConfirmacaoSenha">
                    <button type="button" id="i_buttonEyeConfirmacaoSenha" onclick="exibirConfirmacaoSenha()"
                        tabindex="-1">
                        <div id="iconeEyesConfirmacaoSenha">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_confimacaoSenha" required autocomplete="off">
                    <div class="textoInput-confirmacaoSenha">
                        <i class="fas fa-lock"></i>
                        <span>Confirmação de Senha</span>
                    </div>

                </div>

            </form>

            <!-- Botão que cadastra o usuário no database -->
            <button id="botaoCadastrar" onclick="cadastrar()">Cadastrar</button>

            <div class="botaoFacaLogin">
                <a>Já possui uma conta?</a>
                <div id="iconeFacaLogin" onclick="voltarParaLogin()"><span>Faça Login</span></div>
            </div>

        </div>

    </div>

</body>

</html>

<script>
    // Função para visualização da senha do campo "Senha Login"
    function exibirSenhaLogin() {
        if (i_senhaLogin.type == "password") {
            i_senhaLogin.type = "text";
            iconeEyesLogin.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_senhaLogin.type == 'text') {
            i_senhaLogin.type = "password";
            iconeEyesLogin.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }
    // Função para visualização da senha do campo "Senha Cadastro"
    function exibirSenhaCadastro() {
        if (i_senhaCadastro.type == "password") {
            i_senhaCadastro.type = "text";
            iconeEyesSenhaCadastro.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_senhaCadastro.type == 'text') {
            i_senhaCadastro.type = "password";
            iconeEyesSenhaCadastro.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }
    // Função para visualização da senha do campo "Confirmação de Senha"
    function exibirConfirmacaoSenha() {
        if (i_confimacaoSenha.type == "password") {
            i_confimacaoSenha.type = "text";
            iconeEyesConfirmacaoSenha.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_confimacaoSenha.type == 'text') {
            i_confimacaoSenha.type = "password";
            iconeEyesConfirmacaoSenha.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }

    // CSS: Função para transição da tela de Login e Cadastro
    function irParaCadastro() {
        console.log('Função irParaCadastro chamada!');
        document.getElementById('divContainerLogin').classList.remove('visible');
        document.getElementById('divContainerLogin').classList.add('hidden');
        document.getElementById('divContainerCadastreSe').classList.remove('hidden');
        document.getElementById('divContainerCadastreSe').classList.add('visible');


        i_nomeCadastro.value = "";
        i_emailCadastro.value = "";
        i_senhaCadastro.value = "";
        i_confimacaoSenha.value = "";
    }
    function voltarParaLogin() {
        console.log('Função voltarParaLogin chamada!');
        document.getElementById('divContainerCadastreSe').classList.remove('visible');
        document.getElementById('divContainerCadastreSe').classList.add('hidden');
        document.getElementById('divContainerLogin').classList.remove('hidden');
        document.getElementById('divContainerLogin').classList.add('visible');

        i_emailLogin.value = "";
        i_senhaLogin.value = "";
    }



    // Função de logar
    function entrar() {
        var emailVar = i_emailLogin.value;
        var senhaVar = i_senhaLogin.value;

        if (emailVar == "" || senhaVar == "") {
            console.log('Erro: Email ou senha em branco.');
            // Modal de Erro
            const Toast = Swal.mixin({
                toast: true,
                position: "top-start",
                showConfirmButton: false,
                timer: 3000,
                background: '#000',
                color: '#fff',
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;


                    const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                    if (progressBar) {
                        progressBar.style.background = '#777';
                    }
                }
            });
            Toast.fire({
                icon: "error",
                title: "Ooops...",
                text: "Preencha todos os campos!",
            });
            return false;
        }

        console.log("FORM LOGIN: ", emailVar);
        console.log("FORM SENHA: ", senhaVar);

        fetch("http://localhost:3333/usuarios/autenticar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                emailServer: emailVar,
                senhaServer: senhaVar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!");

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    sessionStorage.EMAIL_USUARIO = json.email;
                    sessionStorage.NOME_USUARIO = json.nome;
                    sessionStorage.ID_USUARIO = json.id;

                    // Toast
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-start",
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#000',
                        color: '#fff',
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;


                            const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                            if (progressBar) {
                                progressBar.style.background = '#777';
                            }
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Sucesso!",
                        text: "Bem-vindo! Acesso liberado com sucesso.",
                    });
                    setTimeout(function () {
                        window.location = "./index.html";
                    }, 3200);
                });

            } else {
                // Modal de Erro
                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-start",
                    showConfirmButton: false,
                    timer: 3000,
                    background: '#000',
                    color: '#fff',
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;


                        const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                        if (progressBar) {
                            progressBar.style.background = '#777';
                        }
                    }
                });
                Toast.fire({
                    icon: "error",
                    title: "Ooops...",
                    text: "Email e/ou senha incorretos!",
                });
                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        })
            .catch(function (erro) {
                console.error("Erro na requisição fetch:", erro);
            });

        return false;
    }


    // Validação da senha do cadastro
    function validarSenha() {
        // Variável da senha digitada
        var senhaVar = i_senhaCadastro.value;
        // Variáveis que verificam o que há na senha digitada 
        var tamanhoValido = senhaVar.length;
        var temMaiuscula = senhaVar.toUpperCase() != senhaVar;
        var temMinuscula = senhaVar.toLowerCase() != senhaVar;
        var temEspecial = false;

        // For para passar caractere por caractere e verificar se há algum caractere especial, caso não haja, a variável "temEspecial", continua como false
        for (var i = 0; i < senhaVar.length; i++) {
            var caractereAtual = senhaVar[i];
            // Verifica se há um dos caracteres citados "!@#$%^&*()"
            if (caractereAtual == `!` || caractereAtual == `@` || caractereAtual == `#` || caractereAtual == `$` || caractereAtual == `%` || caractereAtual == `^` || caractereAtual == `&` || caractereAtual == `*` || caractereAtual == `(` || caractereAtual == `)`) {
                temEspecial = true;
            }
        }
        // Verifica se a senha atende a todos os requisitos listados
        if (tamanhoValido >= 8 && temMaiuscula && temMinuscula && temEspecial) {
            div_validarSenha.innerHTML = `<span class="span_NecSenha" style="color: green">A senha deve conter 8 caracteres, incluindo 1 letra maiúscula, 1 letra
                minúscula e 1 caractere especial.</span>`;
            return true;
        } else {
            div_validarSenha.innerHTML = `<span class="span_NecSenha" style="color: red">A senha deve conter 8 caracteres, incluindo 1 letra maiúscula, 1 letra
                minúscula e 1 caractere especial.</span>`;
            return false;
        }
    }

    // Função de Cadastro
    function cadastrar() {

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var nomeVar = i_nomeCadastro.value;
        var emailVar = i_emailCadastro.value;
        var senhaVar = i_senhaCadastro.value;
        var confirmacaoSenhaVar = i_confimacaoSenha.value;

        // Validando todos os campos
        if (nomeVar != "" && emailVar != "" && senhaVar != "" && confirmacaoSenhaVar != "") { // Validação de campos preenchidos
            if (nomeVar.length > 1) { // Validação de Nome
                if (emailVar.length > 7 && emailVar.includes('@') && emailVar.includes('.')) { // Validação de Email
                    if (validarSenha() == true) { // Validação de Senha
                        if (senhaVar == confirmacaoSenhaVar) { // Validação de coincidencia de Senhas


                            // Enviando dados dos campos ao banco de dados
                            fetch("/usuarios/cadastrar", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    // crie um atributo que recebe o valor recuperado aqui
                                    // Agora vá para o arquivo routes/usuario.js
                                    nomeServer: nomeVar,
                                    emailServer: emailVar,
                                    senhaServer: senhaVar
                                }),
                            })
                                .then(function (resposta) {
                                    console.log("resposta: ", resposta);

                                    if (resposta.ok) {
                                        // Toast de Cadastro efetuado com sucesso
                                        const Toast = Swal.mixin({
                                            toast: true,
                                            position: "top-end",
                                            showConfirmButton: false,
                                            timer: 3000,
                                            background: '#000',
                                            color: '#fff',
                                            timerProgressBar: true,
                                            didOpen: (toast) => {
                                                toast.onmouseenter = Swal.stopTimer;
                                                toast.onmouseleave = Swal.resumeTimer;


                                                const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                                                if (progressBar) {
                                                    progressBar.style.background = '#777';
                                                }
                                            }
                                        });
                                        Toast.fire({
                                            icon: "success",
                                            title: "Sucesso!",
                                            text: "Cadastro realizado!",
                                        });

                                        setTimeout(() => {
                                            voltarParaLogin()
                                        }, 3000);

                                    } else {
                                        // Modal de Erro
                                        const Toast = Swal.mixin({
                                            toast: true,
                                            position: "top-end",
                                            showConfirmButton: false,
                                            timer: 3000,
                                            background: '#000',
                                            color: '#fff',
                                            timerProgressBar: true,
                                            didOpen: (toast) => {
                                                toast.onmouseenter = Swal.stopTimer;
                                                toast.onmouseleave = Swal.resumeTimer;


                                                const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                                                if (progressBar) {
                                                    progressBar.style.background = '#777';
                                                }
                                            }
                                        });
                                        Toast.fire({
                                            icon: "error",
                                            title: "Ooops...",
                                            text: "Este email já está em uso!",
                                        });
                                        throw "Houve um erro ao tentar realizar o cadastro!";
                                    }

                                })
                                .catch(function (resposta) {
                                    console.log(`#ERRO: ${resposta}`);
                                });

                            return false;




                        } else { // Caso as senhas não sejam iguais
                            const Toast = Swal.mixin({
                                toast: true,
                                position: "top-end",
                                showConfirmButton: false,
                                timer: 3000,
                                background: '#000',
                                color: '#fff',
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.onmouseenter = Swal.stopTimer;
                                    toast.onmouseleave = Swal.resumeTimer;

                                    const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                                    if (progressBar) {
                                        progressBar.style.background = '#777';
                                    }
                                }
                            });
                            Toast.fire({
                                icon: "error",
                                title: "Ooops...",
                                text: "As senhas não coincidem!",
                            });
                        }
                    } else { // Caso a senha esteja inválida
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 3000,
                            background: '#000',
                            color: '#fff',
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;

                                const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                                if (progressBar) {
                                    progressBar.style.background = '#777';
                                }
                            }
                        });
                        Toast.fire({
                            icon: "error",
                            title: "Ooops...",
                            text: "Senha inválida!",
                        });
                    }
                } else { // Caso o email seja inválido
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#000',
                        color: '#fff',
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;

                            const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                            if (progressBar) {
                                progressBar.style.background = '#777';
                            }
                        }
                    });
                    Toast.fire({
                        icon: "error",
                        title: "Ooops...",
                        text: "Email inválido!",
                    });
                }
            } else { // Caso o nome não seja válido
                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 3000,
                    background: '#000',
                    color: '#fff',
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;

                        const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                        if (progressBar) {
                            progressBar.style.background = '#777';
                        }
                    }
                });
                Toast.fire({
                    icon: "error",
                    title: "Ooops...",
                    text: "Nome inválido!",
                });
            }


        } else {
            console.log('Erro ao cadastrar')

            // Modal de Erro
            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                background: '#000',
                color: '#fff',
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;


                    const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                    if (progressBar) {
                        progressBar.style.background = '#777';
                    }
                }
            });
            Toast.fire({
                icon: "error",
                title: "Ooops...",
                text: "Preencha todos os campos!",
            });
            return false;
        }

    }

</script>