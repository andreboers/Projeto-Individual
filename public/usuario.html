<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/usuario.css">
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>GTA | Facul Vice</title>
</head>

<body>

    <div id="divContainerLogin" class="visible">

        <!-- Login de Usuário -->
        <div class="divBoxLogin">

            <h1>Faça Login</h1>

            <form>
                <!-- Login -->
                <div class="divCampo" id="div_campoEmailLogin">
                    <input type="text" id="i_emailLogin" required autocomplete="off">
                    <div class="textoInput-email">
                        <i class="fa fa-user" aria-hidden="true"></i>
                        <span>Email</span>
                    </div>
                </div>

                <!-- Senha -->
                <div class="divCampo" id="div_campoSenhaLogin">
                    <button type="button" id="i_buttonEyeSenhaLogin" onclick="exibirSenhaLogin()" tabindex="-1">
                        <div id="iconeEyesLogin">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_senhaLogin" required autocomplete="off">
                    <div class="textoInput-senha">
                        <i class="fas fa-lock"></i>
                        <span>Senha</span>
                    </div>

                </div>

            </form>

            <!-- Botão que executa um select no database -->
            <button id="botaoLogin" onclick="entrar()">Entrar</button>



            <div class="botaoCadastreSe">
                <p>Não possui uma conta?</p>
                <span>Cadastre-se</span>
                <div id="iconeCadastreSe" onclick="irParaCadastro()"><i class="fa-solid fa-arrow-right"></i></div>
            </div>

        </div>

        <div class="divBannerLogin">
        </div>

    </div>


    <!-- Cadastro de Usuário -->
    <div id="divContainerCadastreSe" class="hidden">

        <div class="divBannerCadastro">
        </div>

        <div class="divBoxCadastro">

            <h1>Faça seu Cadastro</h1>

            <form>
                <!-- Nome -->
                <div class="divCampo" id="div_campoNomeCadastro">
                    <input type="text" id="i_nomeCadastro" required autocomplete="off">
                    <div class="textoInput-email">
                        <i class="fa fa-user" aria-hidden="true"></i>
                        <span>Nome</span>
                    </div>
                </div>
                <!-- Email -->
                <div class="divCampo" id="div_campoEmailCadastro">
                    <input type="text" id="i_emailCadastro" required autocomplete="new-email">
                    <div class="textoInput-email">
                        <i class="fa-solid fa-at"></i>
                        <span>Email</span>
                    </div>
                </div>

                <!-- Senha -->
                <div class="divCampo" id="div_campoSenhaCadastro">
                    <button type="button" id="i_buttonEyeSenhaCadastro" onclick="exibirSenhaCadastro()" tabindex="-1">
                        <div id="iconeEyesSenhaCadastro">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_senhaCadastro" required autocomplete="off">
                    <div class="textoInput-senha">
                        <i class="fas fa-lock"></i>
                        <span>Senha</span>
                    </div>

                </div>

                <!-- Confirmação de Senha -->
                <div class="divCampo" id="div_campoConfirmacaoSenha">
                    <button type="button" id="i_buttonEyeConfirmacaoSenha" onclick="exibirConfirmacaoSenha()"
                        tabindex="-1">
                        <div id="iconeEyesConfirmacaoSenha">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </div>
                    </button>
                    <input type="password" id="i_confimacaoSenha" required autocomplete="off">
                    <div class="textoInput-confirmacaoSenha">
                        <i class="fas fa-lock"></i>
                        <span>Confirmação de Senha</span>
                    </div>

                </div>

            </form>

            <!-- Botão que cadastra o usuário no database -->
            <button id="botaoCadastrar" onclick="cadastrar()">Cadastrar</button>

            <div class="botaoFacaLogin">
                <p>Já possui uma conta?</p>
                <span>Faça Login</span>
                <div id="iconeFacaLogin" onclick="voltarParaLogin()"><i class="fa-solid fa-arrow-left"></i></div>
            </div>

        </div>

    </div>

</body>

</html>

<script>
    // Função para visualização da senha do campo "Senha Login"
    function exibirSenhaLogin() {
        if (i_senhaLogin.type == "password") {
            i_senhaLogin.type = "text";
            iconeEyesLogin.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_senhaLogin.type == 'text') {
            i_senhaLogin.type = "password";
            iconeEyesLogin.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }
    // Função para visualização da senha do campo "Senha Cadastro"
    function exibirSenhaCadastro() {
        if (i_senhaCadastro.type == "password") {
            i_senhaCadastro.type = "text";
            iconeEyesSenhaCadastro.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_senhaCadastro.type == 'text') {
            i_senhaCadastro.type = "password";
            iconeEyesSenhaCadastro.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }
    // Função para visualização da senha do campo "Confirmação de Senha"
    function exibirConfirmacaoSenha() {
        if (i_confimacaoSenha.type == "password") {
            i_confimacaoSenha.type = "text";
            iconeEyesConfirmacaoSenha.innerHTML = `<i class="fa fa-eye-slash" aria-hidden=" true" style="font-size: 18px;"></i>`;
        } else if (i_confimacaoSenha.type == 'text') {
            i_confimacaoSenha.type = "password";
            iconeEyesConfirmacaoSenha.innerHTML = `<i class="fa fa-eye" aria-hidden="true"></i>`;
        }
    }

    // CSS: Função para transição da tela de Login e Cadastro
    function irParaCadastro() {
        console.log('Função irParaCadastro chamada!');
        document.getElementById('divContainerLogin').classList.remove('visible');
        document.getElementById('divContainerLogin').classList.add('hidden');
        document.getElementById('divContainerCadastreSe').classList.remove('hidden');
        document.getElementById('divContainerCadastreSe').classList.add('visible');
    }
    function voltarParaLogin() {
        console.log('Função voltarParaLogin chamada!');
        document.getElementById('divContainerCadastreSe').classList.remove('visible');
        document.getElementById('divContainerCadastreSe').classList.add('hidden');
        document.getElementById('divContainerLogin').classList.remove('hidden');
        document.getElementById('divContainerLogin').classList.add('visible');
    }



    // Função de logar
    function entrar() {
        var emailVar = i_emailLogin.value;
        var senhaVar = i_senhaLogin.value;

        if (emailVar == "" || senhaVar == "") {
            console.log('Erro: Email ou senha em branco.');
            // Modal de Erro
            const Toast = Swal.mixin({
                toast: true,
                position: "top-start",
                showConfirmButton: false,
                timer: 3000,
                background: '#000',
                color: '#fff',
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;


                    const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                    if (progressBar) {
                        progressBar.style.background = '#777';
                    }
                }
            });
            Toast.fire({
                icon: "error",
                title: "Ooops...",
                text: "Preencha todos os campos!",
            });
            return false;
        }

        console.log("FORM LOGIN: ", emailVar);
        console.log("FORM SENHA: ", senhaVar);

        fetch("http://localhost:3333/usuarios/autenticar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                emailServer: emailVar,
                senhaServer: senhaVar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!");

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));

                    sessionStorage.EMAIL_USUARIO = json.email;
                    sessionStorage.NOME_USUARIO = json.nome;
                    sessionStorage.ID_USUARIO = json.id;

                    // Toast
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-start",
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#000',
                        color: '#fff',
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;


                            const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                            if (progressBar) {
                                progressBar.style.background = '#777';
                            }
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Sucesso!",
                        text: "Bem-vindo de volta!",
                    });
                    setTimeout(function () {

                        window.location = "./index.html";
                    }, 3200);
                });

            } else {
                // Modal de Erro
                const Toast = Swal.mixin({
                    toast: true,
                    position: "top-start",
                    showConfirmButton: false,
                    timer: 3000,
                    background: '#000',
                    color: '#fff',
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;


                        const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                        if (progressBar) {
                            progressBar.style.background = '#777';
                        }
                    }
                });
                Toast.fire({
                    icon: "error",
                    title: "Ooops...",
                    text: "Email e/ou senha incorretos!",
                });
                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        })
            .catch(function (erro) {
                console.error("Erro na requisição fetch:", erro);
            });

        return false;

    }





    // Funcionando
    function cadastrar() {

        //Recupere o valor da nova input pelo nome do id
        // Agora vá para o método fetch logo abaixo
        var nomeVar = i_nomeCadastro.value;
        var emailVar = i_emailCadastro.value;
        var senhaVar = i_senhaCadastro.value;
        var confirmacaoSenhaVar = i_confimacaoSenha.value;

        // Verificando se há algum campo em branco
        if (
            nomeVar == "" ||
            emailVar == "" ||
            senhaVar == "" ||
            confirmacaoSenhaVar == ""
        ) {
            console.log('Erro ao cadastrar')

            // Modal de Erro
            const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                background: '#000',
                color: '#fff',
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;


                    const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                    if (progressBar) {
                        progressBar.style.background = '#777';
                    }
                }
            });
            Toast.fire({
                icon: "error",
                title: "Ooops...",
                text: "Preencha todos os campos!",
            });
            return false;
        } else {
            console.log('Aguarde')
        }


        // Enviando o valor da nova input
        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeServer: nomeVar,
                emailServer: emailVar,
                senhaServer: senhaVar
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);


                // if (nomeVar.length > 1 && (emailVar.includes('@') && emailVar.includes('.')) && senhaVar.length > 6 && confirmacaoSenhaVar == senhaVar && cpf.length == 11) {


                if (resposta.ok) {
                    // Toast de Cadastro efetuado com sucesso
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#000',
                        color: '#fff',
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;


                            const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                            if (progressBar) {
                                progressBar.style.background = '#777';
                            }
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Sucesso!",
                        text: "Cadastro realizado!",
                    });

                    setTimeout(() => {
                        voltarParaLogin()
                    }, 3000);

                } else {
                    // Modal de Erro
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        background: '#000',
                        color: '#fff',
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;


                            const progressBar = toast.querySelector('.swal2-timer-progress-bar');
                            if (progressBar) {
                                progressBar.style.background = '#777';
                            }
                        }
                    });
                    Toast.fire({
                        icon: "error",
                        title: "Ooops...",
                        text: "Este email já está em uso!",
                    });
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }

            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }

</script>