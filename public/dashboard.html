<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/dashboard.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <script src="js/dashboard.js"></script>
    <script src="js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <title>Dashboard | MineTech</title>
</head>

<body
    onload="validarUsuario(),exibirRank(), exibirPontuacao(), exibirMediaDeAcertos(), exibirQuantidadeDeTentativas(), obterDadosTentativasPorUsuario() ">
    <!-- Menu Lateral da página -->
    <div class="menuLateral">
        <div id="textoPainel"></div>
        <a href="index.html" class="botao">Inicio</a>
        <a href="quiz.html" class="botao">Quiz</a>
        <a class="botao" onclick="sairSessao()">Sair do Perfil</a>
    </div>

    <!-- Conteúdo da Dashboard -->
    <div class="conteudoDashboard">
        <div id="box1">
            <!-- Indicador 1 -->
            <div class="indicadores" id="i_1">
                <p class="tituloIndicadores">Sua pontuação</p>
                <div id="user_pontuacao"></div>
            </div>
            <!-- Indicador 2 -->
            <div class="indicadores" id="i_2">
                <p class="tituloIndicadores">Tentativas do Quiz</p>
                <div id="user_qtdTentativas"></div>
            </div>
            <!-- Indicador 3 -->
            <div class="indicadores" id="i_3">
                <p class="tituloIndicadores">Média de Acertos do Quiz</p>
                <div id="user_mediaAcertos"></div>
            </div>

        </div>

        <!-- Gráficos -->
        <div id="box2">
            <div id="divGraficos">
                <div class="graficos" id="graficoLinha">
                    <div id="graficos1">
                        <!-- <canvas id="grafico"></canvas> -->
                    </div>
                    <div id="graficos2">
                        <canvas id="graficoTentativasUsuarios"></canvas>
                    </div>
                </div>
                <div class="graficos" id="graficoRank">
                    <p>Ranking de Pontos por Usuários</p>
                    <div id="user_rank"></div>
                </div>
            </div>
        </div>

    </div>

</body>

</html>

<script src="./js/dashboard.js"></script>

<script>
    function validarUsuario() {
        var email = sessionStorage.EMAIL_USUARIO;
        var nome = sessionStorage.NOME_USUARIO;

        if (email != null && nome != null) {
            textoPainel.innerHTML = `Painel de ${nome}<br>
            ${email}`;
        }
    }


    // Função para obter os Nomes e Tentativas dos Usuários
    function obterDadosTentativasPorUsuario() {
        fetch(`/dashboard/tentativasPorUsuario`, { cache: 'no-store' }).then(function (response) {
            console.log(response)
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados obtidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoTentativaPorUsuario(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGraficoTentativaPorUsuario(resposta) {

        console.log('iniciando plotagem do gráfico...');

        let labels = [];
        var valores = [];

        console.log(resposta)

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.Nome);
            valores.push(registro.Tentativas);
        }
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(valores)

        const ctx = document.getElementById('graficoTentativasUsuarios');

        Chart.defaults.color = '#fff';
        Chart.defaults.borderColor = '#333';

        new Chart(ctx, {

            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tentativas',
                    data: valores,
                    borderWidth: 1,
                    backgroundColor: ['#6cc349', '#61B5CB', '#D5A0C4'],

                    barPercentage: 0.7,
                    categoryPercentage: 0.7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tentativas dos Usuários',
                        font: {
                            family: 'VT323',
                            size: 30,
                            weight: 'normal',
                        }
                    },
                    legend: {
                        display: true,
                        font: {
                            family: 'VT323',
                            size: 32,
                            weight: 'normal'
                        }
                    },
                    tooltip: {
                        bodyFont: {
                            family: 'VT323',
                            size: 20
                        }
                    }
                },

                scales: {
                    x: {
                        ticks: {
                            font: {
                                family: 'VT323',
                                size: 20
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                family: 'VT323',
                                size: 20
                            }
                        }
                    }
                }
            }
        });
    }



</script>